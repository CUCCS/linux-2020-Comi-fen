# 实验报告五

##### 实验内容：web服务器



## 实验环境

- Virtualbox
- Ubuntu 18.04.4 Server 64bit
- Windows 10
- Nginx (port:8080)
- VeryNginx (port:80)
- Wordpress 
- Damn Vulnerable Web Application (DVWA)



## 实验内容

**1.在一台主机（虚拟机）上同时配置Nginx和VeryNginx**

- 安装Nginx

```json
# 安装Nginx
sudo apt install nginx
```

- 安装VeryNginx

```json
# 安装VeryNginx
git clone https://github.com/alexazhou/VeryNginx.git
sudo apt install libssl-dev libpcre3 libpcre3-dev build-essential
sudo apt install python
cd VeryNginx
sudo python install.py install
```

安装中报错，提示缺少zlib library:

![verynginx安装报错](img/1.png)

```json
# 安装zlib依赖
sudo apt install zlib1g-dev
# 重新安装VeryNginx
sudo python install.py install
```

![安装成功](img/2.png)

- 修改VeryNginx配置文件，默认在/opt/verynginx目录下

```json
cd /opt/verynginx/openresty/nginx/conf
sudo vim nginx.conf
```

`user`变量修改为`www-data`，server的监听端口修改为`192.168.56.102:80`

![user修改](img/3.png)

- 启动VeryNginx服务

```json
# 启动服务
sudo /opt/verynginx/openresty/nginx/sbin/nginx

# 和nginx同时占用80端口，启动失败，需关闭nginx
# 获取nginx进程号
ps -ef | grep nginx

# 结束该进程，再次启动
sudo kill -QUIT 957
sudo /opt/verynginx/openresty/nginx/sbin/nginx
```

![启动失败](img/4.png)

![查看进程号](img/5.png)

- 修改Nginx配置， `sudo vim /etc/nginx/sites-available/default`，将端口改为8080

![nginx配置](img/6.png)


- 启动Nginx服务 `sudo service nginx start`

- 成功访问VeryNginx `192.168.56.102:80`

![访问成功](img/7.png)

![访问主页](img/9.png)

- 成功访问Nginx 

![访问2](img/8.png)

- PHP-FPM进程的反向代理配置在nginx服务器上

```json
# 安装mysql
sudo apt install mysql-server

# 安装php-fpm和php-mysql
sudo apt install php-fpm php-mysql

# 修改nginx文件
sudo vim /etc/nginx/sites-enabled/default
# 取消注释
location ~ \.php$ {
      include snippets/fastcgi-php.conf;
       fastcgi_pass unix:/var/run/php/php7.0-fpm.sock;
  }

# 重新启动nginx
sudo systemctl restart nginx
```

**2.使用Wordpress搭建的站点对外提供访问的地址为： http://wp.sec.cuc.edu.cn**

- 创建数据库wordpress，及对应用户wordpressuser

```json
# 切换到root用户
sudo su
# 登录mysql
mysql -u root -p

# 创建wordpress数据库
CREATE DATABASE wordpress DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci;

# 创建wordpressuser用户
GRANT ALL ON wordpress.* TO 'wordpressuser'@'localhost' IDENTIFIED BY 'password';

# 刷新权限
FLUSH PRIVILEGES;

# 退出mysql
exit;
```

- 安装php模块（已有7.2版本的php）

```json
# 安装php的其他扩展模块
sudo apt install php-curl php-gd php-intl php-mbstring php-soap php-xml php-xmlrpc php-zip

# 重启服务
sudo systemctl restart php7.2-fpm
```

- 安装WordPress4.7

```json
# 下载安装包
cd /tmp
sudo wget https://wordpress.org/wordpress-4.7.zip

# 解压文件
unzip wordpress-4.7.zip

# 将示例配置文件复制到WordPress实际读取的文件中
sudo cp /tmp/wordpress/wp-config-sample.php /tmp/wordpress/wp-config.php

# 复制到文档根目录中
sudo cp -a /tmp/wordpress/. /var/www/html/wordpress

# 赋予/var/www/html可执行权限
sudo chmod -R 777 /var/www/html/wordpress

```

- 配置WordPress

```json
# 从WordPress密钥生成器中获取安全值
curl -s https://api.wordpress.org/secret-key/1.1/salt/

# 复制到以下配置文件中
sudo vim /var/www/html/wp.sec.cuc.edu.cn/wp-config.php
# 替换以下内容
. . .
define('AUTH_KEY',         'VALUES COPIED FROM THE COMMAND LINE');
define('SECURE_AUTH_KEY',  'VALUES COPIED FROM THE COMMAND LINE');
define('LOGGED_IN_KEY',    'VALUES COPIED FROM THE COMMAND LINE');
define('NONCE_KEY',        'VALUES COPIED FROM THE COMMAND LINE');
define('AUTH_SALT',        'VALUES COPIED FROM THE COMMAND LINE');
define('SECURE_AUTH_SALT', 'VALUES COPIED FROM THE COMMAND LINE');
define('LOGGED_IN_SALT',   'VALUES COPIED FROM THE COMMAND LINE');
define('NONCE_SALT',       'VALUES COPIED FROM THE COMMAND LINE');
. . .
```

- 修改nginx配置

```json
sudo vim /etc/nginx/sites-enabled/default
# 修改根访问目录
root /var/www/html/wordpress;
# 更改server_name
server_name wp.sec.cuc.edu.cn;

# 重新加载nginx
sudo systemctl reload nginx
```

- 实现域名http://wp.sec.cuc.edu.cn访问

```json
#在测试虚拟机的/etc/hosts和本机C:\Windows\System32\drivers\etc\hosts添加以下内容
192.168.56.102 wp.sec.cuc.edu.cn
```

![访问成功1](img/10.png)



**3.使用Damn Vulnerable Web Application (DVWA)搭建的站点对外提供访问的地址为： http://dvwa.sec.cuc.edu.cn**

- 安装DVWA

```json
sudo git clone https://github.com/ethicalhack3r/DVWA
sudo mv DVWA /var/www/html

# 将DVWA的配置文件重命名
sudo cp /var/www/html/DVWA/config/config.inc.php.dist /var/www/html/DVWA/config/config.inc.php
```

- 配置php文件

```json
sudo vim /etc/php/7.2/fpm/php.ini

# 修改对应内容
allow_url_include = On
display_errors = off

# 重启php-fpm
sudo systemctl restart php7.2-fpm
```

- 分配访问权限

```json
sudo chown -R www-data.www-data /var/www/html/DVWA
```

- 配置mysql

```json
sudo su
sudo mysql -u root -p

> CREATE DATABASE dvwa DEFAULT CHARACTER SET utf8 COLLATE > > utf8_unicode_ci;
> GRANT ALL ON dvwa.* TO 'dvwauser'@'localhost' IDENTIFIED BY 'p@ssw0rd';
> FLUSH PRIVILEGES;
> EXIT;

# 重启mysql
sudo systemctl restart mysql
```

- 编辑DVWA配置文件

```json
sudo vim /var/www/html/DVWA/config/config.inc.php

# 配置自动生效
$_DVWA[ 'db_server' ]   = '127.0.0.1';
$_DVWA[ 'db_database' ] = 'dvwa';
$_DVWA[ 'db_user' ]     = 'dvwauser';
$_DVWA[ 'db_password' ] = 'p@ssw0rd';
```

- 添加Nginx配置，开启8081监听端口

```json
sudo vim /etc/nginx/sites-available/default

# 添加以下内容
server {
     listen 8081;
     listen [::]:8081;

     server_name dvwa.sec.cuc.edu.cn;

     root /var/www/html/DVWA;
     index index.html setup.php index.htm index.php index.nginx-debian.html;
     location / {
             try_files $uri $uri/ =404;
       }
     #配置php-fpm反向代理
     location ~ \.php$ {
             include snippets/fastcgi-php.conf;
             fastcgi_pass unix:/var/run/php/php7.2-fpm.sock;
     }
 }

# 重启nginx
 sudo systemctl restart nginx
```



## 实验问题

- 因为网络问题无法通过两个链接直接下载wordpress4.7
- 做DVWA任务添加Nginx的配置时，不小心把默认配置直接改了。。。而不是在文件末尾添加配置。。导致Nginx配置出现问题无法启用，而且我没有备份原配置文件。。。准备卸载重装了

## 参考资料

[linux-2019-Cassie8888](https://github.com/CUCCS/linux-2019-Cassie8888)

[linux-2019-jackcily](https://github.com/CUCCS/linux-2019-jackcily)

[alexazhou/VeryNginx](https://github.com/alexazhou/VeryNginx/blob/master/readme_zh.md)